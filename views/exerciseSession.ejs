<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Exercise Session</title>
  <link rel="stylesheet" href="/navbar.css">
  <link rel="stylesheet" href="/weather.css">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Winky+Rough&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/exerciseSession.css">
</head>
<body>

  <%- include('partials/navbar') %>

  <div class="header">
    <div class="header-item">
      <h4>Total Duration</h4>
      <p>00:12</p>
    </div>
    <div class="header-item">
      <h4>XP Gained</h4>
      <p>100</p>
    </div>
    <div class="header-item">
      <h4>Rest Timer</h4>
      <p>01:00</p>
    </div>
  </div>

   <h2 class="mb-4"><%= routine.routineName %> 
    <button id="link-routine-btn" class="btn-link">
  <img src="/images/link.png" alt="Link Routine" style="width: 12px; height: 12px;" /> Link routines
</button>
          <div class="modal" id="routineModal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">√ó</span>
    <h3>Link another routine:</h3>
    <ul id="routineList"></ul>
  </div>
</div>
          </h2>

<div id="exercise-list">
  <% routine.exercises.forEach(exercise => { %>
    <div class="exercise" onclick="startExercise('<%= exercise %>')">
      <div class="icon">üèãÔ∏è‚Äç‚ôÇÔ∏è</div>
      <div class="exercise-name"><%= exercise %></div>
      <div class="arrow">‚Ä∫</div>
    </div>
  <% }); %>

    <button class="finish-btn">Finish Workout</button>

  </div>

  <div id="exercise-detail" style="display: none;">
    <h2 id="exercise-title">Exercise</h2>

    <div class="set-entry">
      <div>Set 1</div>
      <div><input type="number" value="10"> reps</div>
      <div><input type="number" value="20"> lbs</div>
    </div>

    <div class="buttons">
      <button class="btn btn-add" onclick="addSet()">+ New Set</button>
      <button class="btn btn-finish" onclick="finishExercise()">Finish Exercise</button>
    </div>
  </div>

<script>
  async function loadRoutines() {
    try {
      const res = await fetch('/api/routines');
      if (!res.ok) {
        throw new Error(`HTTP error! Status: ${res.status}`);
      }
      const data = await res.json();

      const list = document.getElementById('routineList');
      list.innerHTML = '';
      data.forEach(routine => {
        const li = document.createElement('li');
        li.textContent = routine.routineName;
        li.style.cursor = 'pointer';
        li.onclick = () => addRoutineExercises(routine._id);
        list.appendChild(li);
      });

      document.getElementById('routineModal').style.display = 'block';
    } catch (err) {
      console.error('Failed to load routines:', err);
      alert('Error loading routines. Please try again.');
    }
  }

async function addRoutineExercises(routineId) {
  try {
    console.log('Fetching routine with ID:', routineId);
    const res = await fetch(`/api/routine/${routineId}`);
    if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
    const data = await res.json();

    const exerciseList = document.getElementById('exercise-list');
    const existingExercises = Array.from(exerciseList.querySelectorAll('.exercise-name')).map(el => el.textContent);

    const newExercises = data.exercises.filter(ex => !existingExercises.includes(ex));
    newExercises.forEach(exercise => {
      const div = document.createElement('div');
      div.className = 'exercise';
      div.onclick = () => startExercise(exercise);
      div.innerHTML = `
        <div class="icon">üèãÔ∏è‚Äç‚ôÇÔ∏è</div>
        <div class="exercise-name">${exercise}</div>
        <div class="arrow">‚Ä∫</div>
      `;
      exerciseList.insertBefore(div, document.querySelector('.finish-btn'));
    });

    // Save new exercises to session
    if (newExercises.length > 0) {
      await fetch(`/api/add-exercises/<%= routine._id %>`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ exercises: newExercises })
      });
    }

    closeModal();
  } catch (err) {
    console.error('Failed to add exercises:', err);
    alert('Error adding exercises. Please try again.');
  }
}

  function closeModal() {
    document.getElementById('routineModal').style.display = 'none';
  }

  function addSet() {
    const detailSection = document.getElementById('exercise-detail');
    const existingSets = detailSection.querySelectorAll('.set-entry');
    const setNumber = existingSets.length + 1;

    const newSet = document.createElement('div');
    newSet.className = 'set-entry';
    newSet.innerHTML = `
      <div>Set ${setNumber}</div>
      <div><input type="number" value="10"> reps</div>
      <div><input type="number" value="20"> lbs</div>
    `;

    const buttons = detailSection.querySelector('.buttons');
    detailSection.insertBefore(newSet, buttons);
  }

  function startExercise(name) {
    document.getElementById('exercise-title').textContent = name;
    document.getElementById('exercise-list').style.display = 'none';
    document.getElementById('exercise-detail').style.display = 'block';
  }

  function finishExercise() {
    document.getElementById('exercise-detail').style.display = 'none';
    document.getElementById('exercise-list').style.display = 'block';
  }

  document.getElementById('link-routine-btn').addEventListener('click', loadRoutines);
</script>

</body>
</html>

  <!-- <div class="container mt-5 pt-5 text-center">
    <h2 class="mb-4">Exercise Session: <%= routine.routineName %></h2>

    <button id="show-form-btn" class="btn btn-dark mb-4">+ Add Workout Record</button> -->
    <!-- <form id="exercise-form" action="/routine/<%= routine._id || '000000000000000000000000' %>/session" method="POST" style="display: none;" class="exercise-form mx-auto">
      <div class="form-group">
        <label for="exercise">Exercise</label>
        <select name="exercise" id="exercise" class="form-control" required>
          <option value="">-- Select --</option>
          <% routine.exercises.forEach(exercise => { %>
            <option value="<%= exercise %>"><%= exercise %></option>
          <% }); %>
        </select>
      </div>
      <div class="form-group">
        <label>Sets</label>
        <input type="number" name="sets" class="form-control" min="1">
      </div>
      <div class="form-group">
        <label>Reps</label>
        <input type="number" name="reps" class="form-control" min="1">
      </div>
      <div class="form-group">
        <label>Duration (min)</label>
        <input type="number" name="duration" class="form-control" min="1">
      </div>
      <button type="submit" class="btn btn-primary w-100 mt-3">Add Record</button>
    </form>

    <div class="workout-log mt-5">
      <h4>Workout Log</h4>
      <% if (workouts.length === 0) { %>
        <p>No records yet.</p>
      <% } else { %>
        <ul class="list-group">
          <% workouts.forEach(w => { %>
            <li class="list-group-item">
              <strong><%= w.exercise %></strong> ‚Äî
              <%= w.sets || '‚Äì' %> sets √ó <%= w.reps || '‚Äì' %> reps,
              <%= w.duration || '0' %> min
            </li>
          <% }); %>
        </ul>
      <% } %>
    </div>
  </div>

  <script>
    document.getElementById("show-form-btn").addEventListener("click", () => {
      document.getElementById("exercise-form").style.display = "block";
    });
  </script> -->

</body>
</html>